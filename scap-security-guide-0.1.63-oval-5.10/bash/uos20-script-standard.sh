#!/usr/bin/env bash
###############################################################################
#
# Bash Remediation Script for Standard System Security Profile for UnionTech OS Server 20
#
# Profile Description:
# This profile contains rules to ensure standard security baseline
# of a UnionTech OS Server 20 system. Regardless of your system's workload
# all of these checks should pass.
#
# Profile ID:  standard
# Benchmark ID:  UOS-20
# Benchmark Version:  0.1.63
# XCCDF Version:  1.1
#
# This file was generated by OpenSCAP 1.3.6 using:
# $ oscap xccdf generate fix --profile standard --fix-type bash xccdf-file.xml
#
# This Bash Remediation Script is generated from an OpenSCAP profile without preliminary evaluation.
# It attempts to fix every selected rule, even if the system is already compliant.
#
# How to apply this Bash Remediation Script:
# $ sudo ./remediation-script.sh
#
###############################################################################

###############################################################################
# BEGIN fix (1 / 21) for 'rpm_verify_hashes'
###############################################################################
(>&2 echo "Remediating rule 1/21: 'rpm_verify_hashes'")
(>&2 echo "FIX FOR THIS RULE 'rpm_verify_hashes' IS MISSING!")

# END fix for 'rpm_verify_hashes'

###############################################################################
# BEGIN fix (2 / 21) for 'rpm_verify_permissions'
###############################################################################
(>&2 echo "Remediating rule 2/21: 'rpm_verify_permissions'")
(>&2 echo "FIX FOR THIS RULE 'rpm_verify_permissions' IS MISSING!")

# END fix for 'rpm_verify_permissions'

###############################################################################
# BEGIN fix (3 / 21) for 'configure_bind_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 3/21: 'configure_bind_crypto_policy'")

function remediate_bind_crypto_policy() {
	CONFIG_FILE="/etc/named.conf"
	if test -f "$CONFIG_FILE"; then
		sed -i 's|options {|&\n\tinclude "/etc/crypto-policies/back-ends/bind.config";|' "$CONFIG_FILE"
		return 0
	else
		echo "Aborting remediation as '$CONFIG_FILE' was not even found." >&2
		return 1
	fi
}

remediate_bind_crypto_policy

# END fix for 'configure_bind_crypto_policy'

###############################################################################
# BEGIN fix (4 / 21) for 'configure_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 4/21: 'configure_crypto_policy'")

var_system_crypto_policy='DEFAULT'


stderr_of_call=$(update-crypto-policies --set ${var_system_crypto_policy} 2>&1 > /dev/null)
rc=$?

if test "$rc" = 127; then
	echo "$stderr_of_call" >&2
	echo "Make sure that the script is installed on the remediated system." >&2
	echo "See output of the 'dnf provides update-crypto-policies' command" >&2
	echo "to see what package to (re)install" >&2

	false  # end with an error code
elif test "$rc" != 0; then
	echo "Error invoking the update-crypto-policies script: $stderr_of_call" >&2
	false  # end with an error code
fi

# END fix for 'configure_crypto_policy'

###############################################################################
# BEGIN fix (5 / 21) for 'configure_kerberos_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 5/21: 'configure_kerberos_crypto_policy'")

rm -f /etc/krb5.conf.d/crypto-policies
ln -s /etc/crypto-policies/back-ends/krb5.config /etc/krb5.conf.d/crypto-policies

# END fix for 'configure_kerberos_crypto_policy'

###############################################################################
# BEGIN fix (6 / 21) for 'configure_libreswan_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 6/21: 'configure_libreswan_crypto_policy'")

function remediate_libreswan_crypto_policy() {
    CONFIG_FILE="/etc/ipsec.conf"
    if ! grep -qP "^\s*include\s+/etc/crypto-policies/back-ends/libreswan.config\s*(?:#.*)?$" "$CONFIG_FILE" ; then
        # the file might not end with a new line
        echo -e '\ninclude /etc/crypto-policies/back-ends/libreswan.config' >> "$CONFIG_FILE"
    fi
    return 0
}

remediate_libreswan_crypto_policy

# END fix for 'configure_libreswan_crypto_policy'

###############################################################################
# BEGIN fix (7 / 21) for 'configure_openssl_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 7/21: 'configure_openssl_crypto_policy'")

OPENSSL_CRYPTO_POLICY_SECTION='[ crypto_policy ]'
OPENSSL_CRYPTO_POLICY_SECTION_REGEX='\[\s*crypto_policy\s*\]'
OPENSSL_CRYPTO_POLICY_INCLUSION='.include /etc/crypto-policies/back-ends/opensslcnf.config'
OPENSSL_CRYPTO_POLICY_INCLUSION_REGEX='^\s*\.include\s*/etc/crypto-policies/back-ends/opensslcnf.config$'


  


function remediate_openssl_crypto_policy() {
	CONFIG_FILE=/etc/pki/tls/openssl.cnf
	if test -f "$CONFIG_FILE"; then
		if ! grep -q "^\\s*$OPENSSL_CRYPTO_POLICY_SECTION_REGEX" "$CONFIG_FILE"; then
			printf '\n%s\n\n%s' "$OPENSSL_CRYPTO_POLICY_SECTION" "$OPENSSL_CRYPTO_POLICY_INCLUSION" >> "$CONFIG_FILE"
			return 0
		elif ! grep -q "^\\s*$OPENSSL_CRYPTO_POLICY_INCLUSION_REGEX" "$CONFIG_FILE"; then
			sed -i "s|$OPENSSL_CRYPTO_POLICY_SECTION_REGEX|&\\n\\n$OPENSSL_CRYPTO_POLICY_INCLUSION\\n|" "$CONFIG_FILE"
			return 0
		fi
	else
		echo "Aborting remediation as '$CONFIG_FILE' was not even found." >&2
		return 1
	fi
}

remediate_openssl_crypto_policy

# END fix for 'configure_openssl_crypto_policy'

###############################################################################
# BEGIN fix (8 / 21) for 'configure_ssh_crypto_policy'
###############################################################################
(>&2 echo "Remediating rule 8/21: 'configure_ssh_crypto_policy'")

SSH_CONF="/etc/sysconfig/sshd"

sed -i "/^\s*CRYPTO_POLICY.*$/Id" $SSH_CONF

# END fix for 'configure_ssh_crypto_policy'

###############################################################################
# BEGIN fix (9 / 21) for 'ensure_gpgcheck_globally_activated'
###############################################################################
(>&2 echo "Remediating rule 9/21: 'ensure_gpgcheck_globally_activated'")
(>&2 echo "FIX FOR THIS RULE 'ensure_gpgcheck_globally_activated' IS MISSING!")

# END fix for 'ensure_gpgcheck_globally_activated'

###############################################################################
# BEGIN fix (10 / 21) for 'ensure_redhat_gpgkey_installed'
###############################################################################
(>&2 echo "Remediating rule 10/21: 'ensure_redhat_gpgkey_installed'")
(>&2 echo "FIX FOR THIS RULE 'ensure_redhat_gpgkey_installed' IS MISSING!")

# END fix for 'ensure_redhat_gpgkey_installed'

###############################################################################
# BEGIN fix (11 / 21) for 'security_patches_up_to_date'
###############################################################################
(>&2 echo "Remediating rule 11/21: 'security_patches_up_to_date'")
(>&2 echo "FIX FOR THIS RULE 'security_patches_up_to_date' IS MISSING!")

# END fix for 'security_patches_up_to_date'

###############################################################################
# BEGIN fix (12 / 21) for 'audit_rules_file_deletion_events'
###############################################################################
(>&2 echo "Remediating rule 12/21: 'audit_rules_file_deletion_events'")
(>&2 echo "FIX FOR THIS RULE 'audit_rules_file_deletion_events' IS MISSING!")

# END fix for 'audit_rules_file_deletion_events'

###############################################################################
# BEGIN fix (13 / 21) for 'file_permissions_unauthorized_sgid'
###############################################################################
(>&2 echo "Remediating rule 13/21: 'file_permissions_unauthorized_sgid'")
(>&2 echo "FIX FOR THIS RULE 'file_permissions_unauthorized_sgid' IS MISSING!")

# END fix for 'file_permissions_unauthorized_sgid'

###############################################################################
# BEGIN fix (14 / 21) for 'file_permissions_unauthorized_suid'
###############################################################################
(>&2 echo "Remediating rule 14/21: 'file_permissions_unauthorized_suid'")
(>&2 echo "FIX FOR THIS RULE 'file_permissions_unauthorized_suid' IS MISSING!")

# END fix for 'file_permissions_unauthorized_suid'

###############################################################################
# BEGIN fix (15 / 21) for 'service_autofs_disabled'
###############################################################################
(>&2 echo "Remediating rule 15/21: 'service_autofs_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_autofs_disabled' IS MISSING!")

# END fix for 'service_autofs_disabled'

###############################################################################
# BEGIN fix (16 / 21) for 'service_abrtd_disabled'
###############################################################################
(>&2 echo "Remediating rule 16/21: 'service_abrtd_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_abrtd_disabled' IS MISSING!")

# END fix for 'service_abrtd_disabled'

###############################################################################
# BEGIN fix (17 / 21) for 'service_ntpdate_disabled'
###############################################################################
(>&2 echo "Remediating rule 17/21: 'service_ntpdate_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_ntpdate_disabled' IS MISSING!")

# END fix for 'service_ntpdate_disabled'

###############################################################################
# BEGIN fix (18 / 21) for 'service_oddjobd_disabled'
###############################################################################
(>&2 echo "Remediating rule 18/21: 'service_oddjobd_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_oddjobd_disabled' IS MISSING!")

# END fix for 'service_oddjobd_disabled'

###############################################################################
# BEGIN fix (19 / 21) for 'service_qpidd_disabled'
###############################################################################
(>&2 echo "Remediating rule 19/21: 'service_qpidd_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_qpidd_disabled' IS MISSING!")

# END fix for 'service_qpidd_disabled'

###############################################################################
# BEGIN fix (20 / 21) for 'service_rdisc_disabled'
###############################################################################
(>&2 echo "Remediating rule 20/21: 'service_rdisc_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_rdisc_disabled' IS MISSING!")

# END fix for 'service_rdisc_disabled'

###############################################################################
# BEGIN fix (21 / 21) for 'service_atd_disabled'
###############################################################################
(>&2 echo "Remediating rule 21/21: 'service_atd_disabled'")
(>&2 echo "FIX FOR THIS RULE 'service_atd_disabled' IS MISSING!")

# END fix for 'service_atd_disabled'

